!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=5)}([function(e,t,n){function r(){return r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},r.apply(this,arguments)}var o=n(16),a=n(4);e.exports=r({},o,a)},function(e,t){e.exports=require("path")},function(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=[],r=!0,o=!1,a=void 0;try{for(var s,c=e[Symbol.iterator]();!(r=(s=c.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==c.return||c.return()}finally{if(o)throw a}}return n}function a(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return o(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}function s(){return s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},s.apply(this,arguments)}function c(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){function a(e,t){try{var n=i[e](t),a=n.value}catch(e){return void o(e)}n.done?r(a):Promise.resolve(a).then(s,c)}function s(e){a("next",e)}function c(e){a("throw",e)}var i=e.apply(t,n);s()})}}function i(e,t){return new Promise(function(){var n=c(regeneratorRuntime.mark(function n(r,o){var a,s;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,y(t.find({cardId:{$in:e}}).project({_id:0,mediaUrls:1,questionText:1,answers:1}).toArray());case 2:a=n.sent,s=a.map(function(e){e.questionText=e.questionText.split("\n")[0];var t=e.answers.length>1?"s":"";return e.answers="Answer".concat(t,": ").concat(e.answers.join(", ")),e.mediaUrl=3===e.mediaUrls.length?e.mediaUrls[1]:e.mediaUrls[0],delete e.mediaUrls,e}),r(s);case 5:case"end":return n.stop()}},n,this)}));return function(e,t){return n.apply(this,arguments)}}())}function u(e,t,n){return l.apply(this,arguments)}function l(){return l=c(regeneratorRuntime.mark(function e(t,n,r){var o,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(m.connect(h));case 2:return o=e.sent,a=o.db(v).collection(r),e.next=6,y(a.find().project({_id:0}).toArray());case 6:s=e.sent,n.json(s),o.close();case 9:case"end":return e.stop()}},e,this)})),l.apply(this,arguments)}function f(e,t){return new Promise(function(){var n=c(regeneratorRuntime.mark(function n(r,o){var a,s;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return a=e.db(v).collection("liveQuestions"),n.next=3,y(a.findOne({cardId:t}));case 3:return s=n.sent,n.next=6,y(a.remove(s));case 6:return n.next=8,y(d(e,s));case 8:r();case 9:case"end":return n.stop()}},n,this)}));return function(e,t){return n.apply(this,arguments)}}())}function d(e,t){var n=t.cachedPoints,r=t.cardId;return new Promise(function(){var t=c(regeneratorRuntime.mark(function t(o,a){var s,c,i,u,l,f,d,m,h;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(s=e.db(v).collection("scoreboard"),c=e.db(v).collection("oldCards"),i=(new Date).getTime(),c.updateOne({cardId:r},{$set:{answerPostedAt:i}}),u=[],l=0;l<n.length;++l)f=n[l],d=f.userId,m=f.points,h={updateOne:{filter:{userId:d},update:{$inc:{"allTimeStats.score":m,"monthlyStats.score":m,"weeklyStats.score":m,"allTimeStats.attempts":1,"monthlyStats.attempts":1,"weeklyStats.attempts":1}}}},m>0&&(h.updateOne.update.$push={"allTimeStats.correct":{answerPostedAt:i,cardId:r,points:m}},h.updateOne.update.$inc["monthlyStats.correct"]=1,h.updateOne.update.$inc["weeklyStats.correct"]=1),u.push(h);if(0!==u.length){t.next=9;break}return o(),t.abrupt("return");case 9:return t.next=11,y(s.bulkWrite(u));case 11:return t.next=13,y(p(s));case 13:o();case 14:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}())}function p(e){return new Promise(function(){var t=c(regeneratorRuntime.mark(function t(n,r){var o,a,s,c,i,u,l,f;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,y(e.aggregate([{$project:{_id:0,orderBy:{$literal:["weeklyStats","monthlyStats","allTimeStats"]},userId:1,"allTimeStats.score":1,"allTimeStats.rank":1,"monthlyStats.score":1,"monthlyStats.rank":1,"weeklyStats.score":1,"weeklyStats.rank":1}},{$unwind:"$orderBy"},{$group:{_id:{orderBy:"$orderBy",score:{$switch:{branches:[{case:{$eq:["$orderBy","weeklyStats"]},then:"$weeklyStats.score"},{case:{$eq:["$orderBy","monthlyStats"]},then:"$monthlyStats.score"}],default:"$allTimeStats.score"}}},users:{$push:"$$CURRENT"}}},{$sort:{"_id.score":-1}},{$group:{_id:"$_id.orderBy",scores:{$push:{score:"$_id.score",users:"$users"}}}}]).toArray());case 2:for(o=t.sent,a={},s={allTimeStats:1,monthlyStats:1,weeklyStats:1},o.forEach(function(e){for(var t=e._id,n=e.scores,r=n.length,o=0;o<r;o++){var c=n[o];0!==c.score&&(c.users.forEach(function(e){var n=e[t].rank,r=s[t];if(n!==r){var o=a[e.userId]||{};o[t]=r,a[e.userId]=o}}),s[t]+=c.users.length)}}),c=[],i=Object.keys(a),u=i.length,l=0,f=function(){var e=i[l],t=Number(e),n={updateOne:{filter:{userId:t},update:{$set:{}}}},r=a[e];Object.keys(s).forEach(function(e){var t=r[e];t&&(n.updateOne.update.$set["".concat(e,".rank")]=t)}),c.push(n)};l<u;l++)f();return t.next=14,y(e.bulkWrite(c));case 14:n();case 15:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}())}var m=n(11).MongoClient,h=process.env.MONGODB_URI,v=process.env.MONGO_DB,w=n(12),x=w.processUpload,g=n(0),y=g.tryCatch;e.exports={getRandomQuestion:function(){return new Promise(function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(m.connect(h));case 2:return r=e.sent,o=r.db(v).collection("newCards"),a=r.db(v).collection("oldCards"),e.next=7,y(o.findOne());case 7:if(null!=(s=e.sent)){e.next=11;break}return n(new Error("Empty deck. Please Add More Cards to DB.")),e.abrupt("return");case 11:return e.next=13,y(a.insert(s));case 13:return e.next=15,y(o.remove(s));case 15:t(s),r.close();case 17:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}())},revealAnswerWorkflow:function(e){return new Promise(function(){var t=c(regeneratorRuntime.mark(function t(n,r){var o,a,s;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,y(m.connect(h));case 2:return o=t.sent,a=o.db(v).collection("oldCards"),t.next=6,y(a.findOne({cardId:e}));case 6:return s=t.sent,n(s),t.next=10,y(f(o,e));case 10:o.close();case 11:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}())},addLiveQuestion:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.cardId,e.next=3,y(m.connect(h));case 3:return o=e.sent,a=o.db(v).collection("liveQuestions"),c=o.db(v).collection("oldCards"),e.next=8,y(a.insert(s({},t,{mediaUrls:n})));case 8:return e.next=10,y(c.updateOne({cardId:r},{$set:{mediaUrls:n},$unset:{questionImg:"",questionAltText:"",prevLineImg:"",prevLineAltText:""}}));case 10:o.close();case 11:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),addMediaUrlsToCard:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,s,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=a(n,1),o=r[0],e.next=3,y(m.connect(h));case 3:return s=e.sent,c=s.db(v).collection("oldCards"),e.next=7,y(c.updateOne({cardId:t},{$push:{mediaUrls:o},$unset:{answerImg:"",answerAltText:""}}));case 7:s.close();case 8:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),updateLiveQuestion:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(m.connect(h));case 2:return r=e.sent,o=r.db(v).collection("liveQuestions"),a=n.userId,e.next=7,y(o.update({questionId:t},{$push:{alreadyAnswered:a,cachedPoints:n}}));case 7:r.close();case 8:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),getLiveQuestions:function(){return new Promise(function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(m.connect(h));case 2:return r=e.sent,o=r.db(v).collection("liveQuestions"),e.next=6,y(o.find().toArray());case 6:a=e.sent,t(a),r.close();case 9:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}())},serveLiveQuestions:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(m.connect(h));case 2:return r=e.sent,o=r.db(v).collection("liveQuestions"),e.next=6,y(o.find().toArray());case 6:a=e.sent,n.json(a),r.close();case 9:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),addOrUpdateUser:function(){var e=c(regeneratorRuntime.mark(function e(t){var n,o,a,s,c,i,u,l,f,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(m.connect(h));case 2:return n=e.sent,o=n.db(v).collection("scoreboard"),a=t.userId,e.next=7,y(o.findOne({userId:a}));case 7:if(!(s=e.sent)){e.next=14;break}return i=t.name,u=t.handle,l=t.avatar,f=t.profileBanner,d=t.following,e.next=12,y(o.updateOne({userId:a},(c={$set:{name:i}},r(c,"$set",{handle:u}),r(c,"$set",{avatar:l}),r(c,"$set",{profileBanner:f}),r(c,"$set",{following:d}),c)));case 12:e.next=16;break;case 14:return e.next=16,y(o.insert(t));case 16:n.close();case 17:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),adjustScore:function(e,t){},getScores:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var o,a,s,c,i,u,l,f,d,p,w;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.query,s=a.page,c=void 0===s?1:s,i=a.view,u=void 0===i?"weeklyStats":i,l=a.search,f=void 0===l?"":l,e.next=3,y(m.connect(h));case 3:return d=e.sent,p=d.db(v).collection("scoreboard"),e.next=7,y(p.find(r({handle:{$regex:f,$options:"i"}},"".concat(u,".score"),{$gt:0})).sort((o={},r(o,"".concat(u,".score"),-1),r(o,"handle",1),o)).limit(100*c).toArray());case 7:w=e.sent,console.log("data:",w),n.json(w),d.close();case 11:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),getUserStats:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a,s,c,u,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.query.handle,e.next=3,y(m.connect(h));case 3:return o=e.sent,a=o.db(v).collection("scoreboard"),s=o.db(v).collection("oldCards"),e.next=8,y(a.findOne({handle:r}));case 8:if(c=e.sent){e.next=12;break}return n.json(null),e.abrupt("return");case 12:return u=c.allTimeStats.correct.map(function(e){return e.cardId}),e.next=15,y(i(u,s));case 15:l=e.sent,c.earnedCards=l,n.json(c);case 18:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),getScore:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.params.handle,e.next=3,y(m.connect(h));case 3:return o=e.sent,a=o.db(v).collection("scoreboard"),e.next=7,y(a.findOne({handle:r}));case 7:s=e.sent,n.json(s),o.close();case 10:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),addDeck:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a,s,c,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.file.path,e.next=3,y(x(r));case 3:return o=e.sent,e.next=6,y(m.connect(h));case 6:for(a=e.sent,s=a.db(v).collection("newCards"),c=s.initializeUnorderedBulkOp(),i=0;i<o.length;++i)c.insert(o[i]);return e.next=12,y(c.execute());case 12:a.close(),n.redirect("/");case 14:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),getNewCards:function(e,t){u(e,t,"newCards")},getOldCards:function(e,t){u(e,t,"oldCards")},weeklyMonthlyReset:function(){var e=c(regeneratorRuntime.mark(function e(t,n){var r,o,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,y(m.connect(h));case 2:r=e.sent,o=r.db(v).collection("scoreboard"),a={score:0,attempts:0,correct:0},s={$set:{}},t&&(s.$set.weeklyStats=a),n&&(s.$set.monthlyStats=a),o.update({},s,{multi:!0}),r.close();case 10:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()}},function(e,t,n){var r=n(17),o=process.env,a=o.TWITTER_API_KEY,s=o.TWITTER_API_SECRET,c=o.TWITTER_TOKEN,i=o.TWITTER_TOKEN_SECRET,u=(o.TWITTER_ACCOUNT,{consumer_key:a,consumer_secret:s,access_token:c,access_token_secret:i});e.exports=new r(u)},function(e,t,n){function r(e){return Array.isArray(e)?e:Array.from(e)}function o(e){throw new Error('"'+e+'" is read-only')}function a(e,t){var n=[],r=!0,o=!1,a=void 0;try{for(var s,c=e[Symbol.iterator]();!(r=(s=c.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==c.return||c.return()}finally{if(o)throw a}}return n}function s(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return a(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}function c(e){return-1!==e}function i(e){return 0!==e.replace(/\[\]/g,"").trim().length}function u(e){var t=/\[.*?\]/g;return(e.match(t)||[]).length+e.replace(t,"").replace(/[\s+\(\)]/g,"").length}function l(e){var t=(e.match(/\?/g)||[]).length;return u(e)-t}function f(e){return[l(e),u(e)]}function d(e){return x(v(h(m(p(e.match(/\:\:.+?\:\:(.+?)\}\}/)[1]))))).map(function(e){if("."===e)return"[]";if("-"===e)return"[] [] [] [] []";if(/\?/.test(e)){for(var t=[],n=Number(e.match(/\d+/)[0]),r=0;r<n;r++)t.push("[?]");return 1===t.length?"[?]":"("+t.join(" ")+")"}return/≠/.test(e)?"[≠".concat(e.replace(/≠/g,""),"]"):e}).join(" ")}function p(e){return e.replace(/(\?+)/g,function(e,t){return"(".concat(t.length,"?)")})}function m(e){return e.replace(/≠[^(]/g,"($&)")}function h(e){return e.replace(/≠\((.*)\)/g,"(≠$1)")}function v(e){return e.split(/[\(\)]/).map(function(e){return/\?|≠/.test(e)?e:e.split("")})}function w(e){return!Array.isArray(e)}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(0===e.length)return t;var n=r(e),o=n[0],a=n.slice(1);return w(o)?x(a,t.concat(o)):x(a,t.concat(x(o)))}var g=n(18),y=process.env.TWITTER_ACCOUNT;e.exports={HOURS:36e5,formatQuestionAltText:function(e){var t=d(e),n=f(t),r=s(n,2),o=r[0],a=r[1],c=o===a?o:"".concat(o," to ").concat(a),i=a>1?"s":"",u="(".concat(c," character").concat(i,")");return e.replace(/\{\{.+?\}\}/g,u)},formatQuestionText:function(e,t,n,r){var o=d(e),a=f(o),c=s(a,2),u=c[0],l=c[1],p=u===l?u:"".concat(u,"-").concat(l),m="What ".concat(p,' character answer means "').concat(t,'"?');return i(o)&&(m+="\nHint: ".concat(o)),n&&(m+="\nNotes: ".concat(n)),m+="\nQID".concat(r)},formatAnswerAltText:function(e){return e.replace(/\{\{.*?\:\:(.+?)\:\:.*?\}\}/g,"$1")},formatAnswerText:function(e,t,n,r){var o=e.length>1?"s":"",a="Answer".concat(o,": ").concat(e.join(", "));return a+='\nEnglish Meaning: "'.concat(t,'"'),a+="\nDefinition: https://ejje.weblio.jp/content/"+g(n),a+="\nQID".concat(r)},addQuestionLink:function(e,t){var n="Question: twitter.com/".concat(y,"/status/").concat(t),r=e.split("\n");return r.splice(-1,0,n),r.join("\n")},getAnswers:function(e,t){var n=e.match(/\:\:(.+?)\:\:/)[1],r=[];return t&&t.length>0&&(r=t.split(",")),[n].concat(r)},calculateScore:function(e,t){var n=t.questionPostedAt,r=(t.alreadyAnswered,Math.floor((new Date(e)-new Date(n))/36e5)),o=24-r;return Math.max(o,0)},extractAnswer:function(e){return e.trim().slice(y.length+2)},getTimeUntil:function(e){var t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),e,0,0,0)-t;return n<0&&(n+=(o("millisUntilTime"),864e5)),n},tryCatch:function(e){return e.then(function(e){return e}).catch(function(e){return console.error("Error:",e),{}})},contains:function(e,t){return c(t.indexOf(e))}}},function(e,t,n){n(6),e.exports=n(7)},function(e,t){e.exports=require("@babel/polyfill")},function(e,t,n){var r=n(8),o=r(),a=n(1),s=n(9);n(10);o.set("port",process.env.PORT||3e3),o.use(r.static(a.resolve(__dirname,"../dist"))),o.use(s.json()),n(19)(o),o.listen(o.get("port"),function(){return console.log("Listening on port",o.get("port"))}),e.exports=o},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("body-parser")},function(e,t,n){function r(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){function a(e,t){try{var n=i[e](t),a=n.value}catch(e){return void o(e)}n.done?r(a):Promise.resolve(a).then(s,c)}function s(e){a("next",e)}function c(e){a("throw",e)}var i=e.apply(t,n);s()})}}function o(){return a.apply(this,arguments)}function a(){return a=r(regeneratorRuntime.mark(function e(){var t,n,r,o,a,c,i,l,f,d,p,m,h;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w(u.getRandomQuestion());case 2:if(t=e.sent,n=t.cardId,r=t.questionText,o=t.questionImg,a=t.questionAltText,c=t.prevLineImg,i=t.prevLineAltText,l=t.answers,n){e.next=12;break}return e.abrupt("return");case 12:return e.next=14,w(v(r,o,a,c,i));case 14:f=e.sent,d=f.questionId,p=f.questionPostedAt,m=f.mediaUrls,h={cardId:n,questionId:d,questionText:r,answers:l,questionPostedAt:p,cachedPoints:[],alreadyAnswered:[]},u.addLiveQuestion(h,m),setTimeout(function(){return s(n,d)},y);case 21:case"end":return e.stop()}},e,this)})),a.apply(this,arguments)}function s(e,t){return c.apply(this,arguments)}function c(){return c=r(regeneratorRuntime.mark(function e(t,n){var r,o,a,s,c,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w(u.revealAnswerWorkflow(t));case 2:return r=e.sent,o=r.answerText,a=r.answerImg,s=r.answerAltText,e.next=8,w(v(f(o,n),a,s));case 8:c=e.sent,i=c.mediaUrls,u.addMediaUrlsToCard(t,i);case 11:case"end":return e.stop()}},e,this)})),c.apply(this,arguments)}function i(){var e=x.stream("statuses/filter",{track:"@".concat(g)});e.on("tweet",function(){var e=r(regeneratorRuntime.mark(function e(t){var n,r,o,a,s,c,i,l,f,v,x,g,y,T,b,S,k;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.in_reply_to_status_id_str,r=t.created_at,o=t.text,a=t.user,s=a.id,c=a.name,i=a.screen_name,l=a.profile_image_url_https,f=a.profile_banner_url,e.next=3,w(u.getLiveQuestions());case 3:if(v=e.sent,!(x=v.find(function(e){return e.questionId===n}))){e.next=16;break}if(g=x.alreadyAnswered,y=x.answers,!p(s,g)){e.next=9;break}return e.abrupt("return");case 9:return e.next=11,w(h(s));case 11:T=e.sent,b={userId:s,name:c,handle:i,avatar:l,profileBanner:f,following:T,allTimeStats:{score:0,attempts:0,correct:[]},monthlyStats:{score:0,attempts:0,correct:0},weeklyStats:{score:0,attempts:0,correct:0}},u.addOrUpdateUser(b),S=m(o),p(S,y)?(k=d(r,x),u.updateLiveQuestion(n,{userId:s,points:k})):u.updateLiveQuestion(n,{userId:s,points:0});case 16:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()),e.on("disconnect",function(t){console.error("Tweet stream disconnected:",t),setTimeout(function(){return e.start()},100)})}var u=n(2),l=n(0),f=(l.HOURS,l.addQuestionLink),d=l.calculateScore,p=l.contains,m=l.extractAnswer,h=l.getFollowing,v=(l.getTimeUntil,l.postMedia),w=l.tryCatch,x=n(3),g=process.env.TWITTER_ACCOUNT,y=4e4,T=1e4;e.exports={start:function(){i(),setInterval(o,T)}}},function(e,t){e.exports=require("mongodb")},function(e,t,n){function r(e,t){var n=[],r=!0,o=!1,a=void 0;try{for(var s,c=e[Symbol.iterator]();!(r=(s=c.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==c.return||c.return()}finally{if(o)throw a}}return n}function o(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return r(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}function a(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){function a(e,t){try{var n=i[e](t),a=n.value}catch(e){return void o(e)}n.done?r(a):Promise.resolve(a).then(s,c)}function s(e){a("next",e)}function c(e){a("throw",e)}var i=e.apply(t,n);s()})}}function s(e){return new Promise(function(){var t=a(regeneratorRuntime.mark(function t(n,r){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:o=h.createReadStream(e).pipe(x.Extract({path:"uploads"})),o.on("close",a(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=h.readdirSync(g),e.next=3,R(c(g+"/media"));case 3:console.log("Finished optimizing images!"),r=i(t),p(t),n(r);case 7:case"end":return e.stop()}},e,this)})));case 2:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}())}function c(e){return new Promise(function(t,n){var r=[];h.readdirSync(e).forEach(function(t){if(/.*\.png$/.test(t)){var n=e+"/"+t,o=h.readFileSync(n),a=h.createWriteStream(n),s=new Promise(function(e,t){return a.on("close",e)});r.push(s),new v({filterType:4,deflateLevel:1}).parse(o,function(e,t){t.data[3]-=1,t.pack().pipe(a)})}}),Promise.all(r).then(t)})}function i(e){var t=[],n=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var c=a.value,i="".concat(g,"/").concat(c);if(h.statSync(i).isFile()&&c.match(/.+\.json$/)){var l=u(i);t=t.concat(l)}}}catch(e){r=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw o}}return t}function u(e){return JSON.parse(h.readFileSync(e,"utf8")).notes.map(function(e){var t=o(e.fields,14),n=t[0],r=t[3],a=t[5],s=t[6],c=t[8],i=t[9],u=t[10],f=t[11],p=t[12],m=t[13],h=[n,r,p].map(l),v=o(h,3);n=v[0],r=v[1],p=v[2];var w=A(n,u);return{cardId:m,questionText:b(n,r,p,m),questionImg:d(a),questionAltText:T(n),prevLineImg:d(c),prevLineAltText:i,answerText:k(w,r,f,m),answerImg:d(s),answerAltText:S(n),answers:w,mediaUrls:[]}})}function l(e){return e.replace(/<.*?>|&.*;/g,"")}function f(e){return(e.match(/src="(.+)"/)||[,])[1]}function d(e){if(e&&0!==e.length){var t;try{t=h.readFileSync("".concat(g,"/media/").concat(f(e)),{encoding:"base64"})}catch(e){}return t}}function p(e){var t=!0,n=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(t=(o=a.next()).done);t=!0){var s=o.value,c="".concat(g,"/").concat(s);h.lstatSync(c).isFile()?h.unlinkSync(c):h.lstatSync(c).isDirectory()&&m(c)}}catch(e){n=!0,r=e}finally{try{t||null==a.return||a.return()}finally{if(n)throw r}}}function m(e){h.existsSync(e)&&(h.readdirSync(e).forEach(function(t){var n=e+"/"+t;h.lstatSync(n).isDirectory()?m(n):h.unlinkSync(n)}),h.rmdirSync(e))}var h=n(13),v=n(14).PNG,w=n(1),x=n(15),g=w.resolve(__dirname,"../uploads"),y=n(0),T=y.formatQuestionAltText,b=y.formatQuestionText,S=y.formatAnswerAltText,k=y.formatAnswerText,A=y.getAnswers,R=y.tryCatch;e.exports={processUpload:s,parseAnkiJson:u,optimizeImages:c}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("pngjs2")},function(e,t){e.exports=require("unzip-stream")},function(e,t,n){function r(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){function a(e,t){try{var n=i[e](t),a=n.value}catch(e){return void o(e)}n.done?r(a):Promise.resolve(a).then(s,c)}function s(e){a("next",e)}function c(e){a("throw",e)}var i=e.apply(t,n);s()})}}function o(e,t){return new Promise(function(n,r){a.post("media/upload",{media_data:e},function(e,o,s){if(e)return console.error(e),void r(new Error("Media upload failed."));var c=o.media_id_string,i={media_id:c,alt_text:{text:t}};a.post("media/metadata/create",i,function(e,t,o){e&&(console.error(e),r(new Error("Media upload succeeded, media creation failed."))),n(c)})})})}var a=n(3),s=n(4),c=s.tryCatch;e.exports={postMedia:function(e,t,n,s,i){return new Promise(function(){var u=r(regeneratorRuntime.mark(function r(u,l){var f,d,p,m;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,c(o(t,n));case 2:if(f=r.sent,d=[f],!s){r.next=9;break}return r.next=7,c(o(s,i));case 7:p=r.sent,d.unshift(p);case 9:m={status:e,media_ids:d,tweet_mode:"extended",include_ext_alt_text:!0},a.post("statuses/update",m,function(e,t,n){e&&(console.error(e),l(new Error("Posting status failed.")));var r=t.extended_entities.media.map(function(e){return{image:e.media_url_https,altText:e.ext_alt_text}}),o={questionId:t.id_str,questionPostedAt:t.created_at,mediaUrls:r};u(o)});case 11:case"end":return r.stop()}},r,this)}));return function(e,t){return u.apply(this,arguments)}}())},getFollowing:function(e){return new Promise(function(t,n){a.get("friends/ids",{userId:e},function(e,n,r){e&&console.error(e),t(n.ids)})})}}},function(e,t){e.exports=require("twit")},function(e,t){e.exports=require("urlencode")},function(e,t,n){var r=n(2),o=n(20)({dest:"uploads/"});e.exports=function(e){e.use(function(e,t,n){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET, OPTIONS"),t.header("Access-Control-Max-Age","86400"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n()}),e.get("/api/live",function(e,t){r.serveLiveQuestions(e,t)}),e.get("/api/scores",function(e,t){r.getScores(e,t)}),e.get("/api/userStats",function(e,t){r.getUserStats(e,t)}),e.get("/api/cards/old",function(e,t){r.getOldCards(e,t)}),e.post("/deck/new",o.single("zipfile"),function(e,t){r.addDeck(e,t)}),e.post("/scores/edit",function(e,t){r.adjustScore(e,t)}),e.get("/cards/new",function(e,t){r.getNewCards(e,t)})}},function(e,t){e.exports=require("multer")}]);